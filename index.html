<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULtty - Terminal Serial Compartilhado</title>
    
    <!-- Biblioteca Paho MQTT para comunicação sem backend -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4;
            --terminal-bg: #000000;
            --terminal-text: #00ff00;
            --chat-bg: #2d2d2d;
            --border-color: #444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #252526;
            border-bottom: 1px solid var(--border-color);
            height: 60px;
            flex-shrink: 0;
        }

        .login-area {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: #3c3c3c;
            color: white;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            letter-spacing: 2px;
        }

        /* --- Layout Principal --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden; /* Impede scroll na página inteira */
        }

        /* Coluna Esquerda (Chat e Usuários) - 1/3 */
        .left-column {
            width: 33.33%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            min-width: 300px;
        }

        /* Coluna Direita (Terminal e Dados) - 2/3 */
        .right-column {
            width: 66.67%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Componentes Genéricos de Painel */
        .panel {
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
        }

        .panel-header {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        /* --- Chat --- */
        #chat-panel {
            flex: 1; /* Ocupa o espaço disponível */
            background-color: var(--chat-bg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .msg {
            word-wrap: break-word;
        }
        .msg .sender {
            font-weight: bold;
            color: var(--accent-color);
        }
        .msg.system {
            color: #888;
            font-style: italic;
        }

        #chat-input-area {
            display: flex;
            padding: 10px;
            background: #252526;
            border-top: 1px solid var(--border-color);
        }

        #chat-input-area input {
            flex: 1;
        }

        /* --- Lista de Usuários --- */
        #users-panel {
            height: 150px;
            background-color: #252526;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .user-item {
            padding: 5px 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }
        .user-item.me {
            color: var(--accent-color);
        }
        .user-item .serial-indicator {
            font-size: 0.7rem;
            background: #4caf50;
            padding: 2px 5px;
            border-radius: 3px;
            display: none;
        }
        .user-item.has-serial .serial-indicator {
            display: inline-block;
        }

        /* --- Terminal --- */
        #terminal-panel {
            flex: 1;
            background-color: var(--terminal-bg);
            color: var(--terminal-text);
            font-family: 'Courier New', Courier, monospace;
            padding: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #terminal-output {
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 1rem;
            line-height: 1.2;
        }

        /* Campo invisível para capturar digitação no mobile/desktop sem keydown event complexo */
        #terminal-input-hidden {
            position: absolute;
            opacity: 0;
            top: -1000px;
        }

        .terminal-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            padding: 5px 0;
            border-top: 1px solid #333;
            margin-top: 5px;
        }
        
        .control-group {
            display: flex;
            gap: 2px;
        }
        
        .control-input {
            width: 30px !important;
            padding: 0 !important;
            text-align: center;
        }

        .btn-special {
            font-size: 0.8rem;
            background-color: #444;
            padding: 4px;
        }

        /* --- Serial Data --- */
        #serial-data-panel {
            height: 120px;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #aaa;
            flex-shrink: 0;
        }
        .log-tx { color: #ff6b6b; } /* Enviado >> */
        .log-rx { color: #4ecdc4; } /* Recebido << */

        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                overflow-y: auto;
            }
            .left-column, .right-column {
                width: 100%;
                border-right: none;
                height: 50vh; /* Divide a tela meio a meio no mobile */
            }
            .app-title {
                font-size: 1.2rem;
            }
            header {
                flex-direction: column;
                height: auto;
                gap: 10px;
                padding-bottom: 15px;
            }
            .login-area {
                width: 100%;
            }
            .login-area input {
                flex: 1;
            }
        }
    </style>
</head>
<body>

    <!-- Topo -->
    <header>
        <div class="login-area" id="login-area">
            <input type="text" id="username" placeholder="Seu Nome" maxlength="15">
            <input type="text" id="roomname" placeholder="Sala (ex: sala1)" value="sala1">
            <button onclick="enterRoom()">Entrar</button>
        </div>
        <div class="app-title">MULtty</div>
        <div>
            <button id="btn-connect-serial" onclick="connectSerial()" disabled>Conectar Serial</button>
        </div>
    </header>

    <!-- Área Principal -->
    <div class="main-container" id="main-interface" style="display:none;">
        
        <!-- Coluna Esquerda (Chat e Usuários) -->
        <div class="left-column">
            <div class="panel" id="chat-panel">
                <div class="panel-header">Chat</div>
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-msg-input" placeholder="Digite uma mensagem..." disabled>
                    <button id="btn-send-chat" onclick="sendChat()" disabled>Enviar</button>
                </div>
            </div>
            <div class="panel" id="users-panel">
                <div class="panel-header">Usuários na Sala</div>
                <div id="users-list">
                    <!-- Lista preenchida via JS -->
                </div>
            </div>
        </div>

        <!-- Coluna Direita (Terminal e Dados) -->
        <div class="right-column">
            <div class="panel" id="terminal-panel" onclick="focusTerminalInput()">
                <div class="panel-header">Terminal</div>
                <div id="terminal-output">Aguardando conexão serial...</div>
                
                <!-- Controles Especiais -->
                <div class="terminal-controls">
                    <button class="btn-special" onclick="sendSpecialChar('\t')">TAB</button>
                    <button class="btn-special" onclick="sendSpecialChar('\x1b[A')">↑</button>
                    <button class="btn-special" onclick="sendSpecialChar('\x1b[B')">↓</button>
                    <button class="btn-special" onclick="sendSpecialChar('\x1b[C')">→</button>
                    <button class="btn-special" onclick="sendSpecialChar('\x1b[D')">←</button>
                    
                    <div class="control-group">
                        <button class="btn-special" onclick="sendModifiedKey('c')">Ctrl</button>
                        <input type="text" id="ctrl-char" class="control-input" maxlength="1" placeholder="+">
                    </div>
                    <div class="control-group">
                        <button class="btn-special" onclick="sendModifiedKey('a')">Alt</button>
                        <input type="text" id="alt-char" class="control-input" maxlength="1" placeholder="+">
                    </div>
                </div>
            </div>

            <!-- Campo invisível para capturar entrada de teclado -->
            <input type="text" id="terminal-input-hidden" autocomplete="off">

            <div class="panel" id="serial-data-panel">
                <div class="panel-header">Serial Data</div>
                <div id="serial-log"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Configurações MQTT ---
        // Usando broker público gratuito para demonstração "serverless"
        const MQTT_HOST = "broker.emqx.io";
        const MQTT_PORT = 8083; // WebSocket Port
        let mqttClient = null;
        let isConnectedToMQTT = false;

        // --- Estado da Aplicação ---
        let currentUser = "";
        let currentRoom = "";
        let myId = Math.random().toString(16).substr(2, 8);
        let serialPort = null;
        let serialWriter = null;
        let serialReader = null;
        let isSerialConnected = false;
        let serialLockedBy = null; // ID do usuário que detém a serial

        // --- Elementos do DOM ---
        const elUsername = document.getElementById('username');
        const elRoomname = document.getElementById('roomname');
        const elMainInterface = document.getElementById('main-interface');
        const elBtnConnectSerial = document.getElementById('btn-connect-serial');
        const elChatMessages = document.getElementById('chat-messages');
        const elChatInput = document.getElementById('chat-msg-input');
        const elBtnSendChat = document.getElementById('btn-send-chat');
        const elTerminalOutput = document.getElementById('terminal-output');
        const elTerminalInputHidden = document.getElementById('terminal-input-hidden');
        const elUsersList = document.getElementById('users-list');
        const elSerialLog = document.getElementById('serial-log');

        // Mapa de usuários ativos (simplificado)
        let users = {};

        // --- Inicialização ---
        function enterRoom() {
            const name = elUsername.value.trim();
            const room = elRoomname.value.trim();

            if (!name || !room) {
                alert("Por favor, insira Nome e Sala.");
                return;
            }

            currentUser = name;
            currentRoom = room;

            // Atualiza UI
            document.getElementById('login-area').style.display = 'none';
            elMainInterface.style.display = 'flex';
            elChatInput.disabled = false;
            elBtnSendChat.disabled = false;

            initMQTT();
        }

        // --- MQTT Lógica ---
        function initMQTT() {
            // Cria cliente ID único
            const clientId = "multry_" + myId;
            mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, clientId);

            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            mqttClient.connect({
                onSuccess: onConnect,
                useSSL: true // WSS
            });
        }

        function onConnect() {
            isConnectedToMQTT = true;
            console.log("MQTT Conectado");

            // Tópicos: Baseados na sala
            const topicBase = `multry/${currentRoom}`;
            
            // Inscreve nos canais
            mqttClient.subscribe(`${topicBase}/chat`);
            mqttClient.subscribe(`${topicBase}/presence`);
            mqttClient.subscribe(`${topicBase}/serial/data`); // Dados vindos da serial (RX)
            mqttClient.subscribe(`${topicBase}/serial/input`); // Dados para enviar para serial (TX)
            mqttClient.subscribe(`${topicBase}/serial/lock`); // Controle de quem é o dono da serial

            // Anuncia presença
            publishMessage(`${topicBase}/presence`, JSON.stringify({
                type: 'join',
                id: myId,
                name: currentUser,
                hasSerial: false
            }));

            // Foca no terminal para captura de teclas
            focusTerminalInput();
        }

        function onConnectionLost(responseObject) {
            isConnectedToMQTT = false;
            if (responseObject.errorCode !== 0) {
                console.log("Conexão perdida:" + responseObject.errorMessage);
                addSystemMessage("Desconectado do servidor. Tentando reconectar...", 'chat');
                // Tenta reconectar após 5s
                setTimeout(initMQTT, 5000);
            }
        }

        function publishMessage(topic, payload) {
            if (!isConnectedToMQTT) return;
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            mqttClient.send(message);
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            const topicBase = `multry/${currentRoom}`;

            try {
                // Chat
                if (topic === `${topicBase}/chat`) {
                    const data = JSON.parse(payload);
                    addChatMessage(data.sender, data.text);
                }
                // Presença
                else if (topic === `${topicBase}/presence`) {
                    const data = JSON.parse(payload);
                    handlePresence(data);
                }
                // Serial Data (Recebido da porta serial -> Mostrar no terminal)
                else if (topic === `${topicBase}/serial/data`) {
                    appendToTerminal(payload, false);
                    logSerialData(payload, 'rx');
                }
                // Serial Input (Digitado no terminal -> Enviar para a porta serial local)
                else if (topic === `${topicBase}/serial/input`) {
                    if (isSerialConnected && serialWriter) {
                        serialWriter.write(payload);
                        logSerialData(payload, 'tx');
                    }
                }
                // Serial Lock (Mutex)
                else if (topic === `${topicBase}/serial/lock`) {
                    const data = JSON.parse(payload);
                    updateSerialLock(data);
                }
            } catch (e) {
                console.error("Erro ao processar mensagem", e);
            }
        }

        // --- Lógica de Chat ---
        function sendChat() {
            const text = elChatInput.value.trim();
            if (!text) return;

            const topicBase = `multry/${currentRoom}`;
            const payload = JSON.stringify({
                sender: currentUser,
                text: text
            });
            publishMessage(`${topicBase}/chat`, payload);
            elChatInput.value = '';
        }

        // Permitir enviar com Enter
        elChatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendChat();
        });

        function addChatMessage(sender, text) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<span class="sender">${sender}:</span> ${escapeHtml(text)}`;
            elChatMessages.appendChild(div);
            elChatMessages.scrollTop = elChatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'msg system';
            div.textContent = text;
            elChatMessages.appendChild(div);
        }

        // --- Lógica de Presença ---
        function handlePresence(data) {
            if (data.id === myId) return; // Ignora a si mesmo

            if (data.type === 'join') {
                // Novo usuário
                users[data.id] = { name: data.name, hasSerial: false };
                renderUsers();
                // Responder para ele saber que eu existo
                const topicBase = `multry/${currentRoom}`;
                publishMessage(`${topicBase}/presence`, JSON.stringify({
                    type: 'announce',
                    id: myId,
                    name: currentUser,
                    hasSerial: isSerialConnected
                }));
                addSystemMessage(`${data.name} entrou na sala.`);
            } 
            else if (data.type === 'announce') {
                users[data.id] = { name: data.name, hasSerial: data.hasSerial };
                renderUsers();
            }
            else if (data.type === 'leave') {
                delete users[data.id];
                renderUsers();
            }
            else if (data.type === 'update_serial') {
                if (users[data.id]) {
                    users[data.id].hasSerial = data.hasSerial;
                    renderUsers();
                }
            }
        }

        function renderUsers() {
            elUsersList.innerHTML = '';
            
            // Me
            const meDiv = document.createElement('div');
            meDiv.className = 'user-item me';
            meDiv.innerHTML = `
                ${currentUser} (Eu)
                <span class="serial-indicator">Serial Conectada</span>
            `;
            if (isSerialConnected) meDiv.classList.add('has-serial');
            elUsersList.appendChild(meDiv);

            // Outros
            for (let id in users) {
                const u = users[id];
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    ${u.name}
                    <span class="serial-indicator">Serial Conectada</span>
                `;
                if (u.hasSerial) div.classList.add('has-serial');
                elUsersList.appendChild(div);
            }
        }

        // --- Web Serial API ---
        async function connectSerial() {
            if (!("serial" in navigator)) {
                alert("Seu navegador não suporta a Web Serial API. Use Chrome, Edge ou Opera.");
                return;
            }

            try {
                // Solicita porta
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 9600 }); // Padrão, poderia ser dinâmico

                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(serialPort.writable);
                serialWriter = textEncoder.writable.getWriter();

                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = serialPort.readable.pipeTo(textDecoder.writable);
                const reader = textDecoder.readable.getReader();
                serialReader = reader;

                isSerialConnected = true;
                
                // UI Updates
                elBtnConnectSerial.textContent = "Serial Conectada";
                elBtnConnectSerial.disabled = true;
                elTerminalOutput.textContent = ""; // Limpa buffer antigo
                logSerialData("--- Conexão Serial Estabelecida ---", 'rx');

                // Anuncia para a sala que pegou o lock
                const topicBase = `multry/${currentRoom}`;
                const lockPayload = JSON.stringify({
                    action: 'lock',
                    id: myId,
                    name: currentUser
                });
                publishMessage(`${topicBase}/serial/lock`, lockPayload);

                // Anuncia presença atualizada
                publishMessage(`${topicBase}/presence`, JSON.stringify({
                    type: 'update_serial',
                    id: myId,
                    hasSerial: true
                }));

                // Loop de Leitura
                readSerialLoop();

                // Tratamento de desconexão da aba
                window.addEventListener("beforeunload", () => {
                     unlockSerial();
                });

            } catch (err) {
                console.error("Erro Serial:", err);
                alert("Erro ao conectar serial: " + err.message);
            }
        }

        async function readSerialLoop() {
            try {
                while (serialPort.readable && isSerialConnected) {
                    const { value, done } = await serialReader.read();
                    if (done) break;
                    if (value) {
                        // Envia o dado recebido para o tópico de dados serial
                        const topicBase = `multry/${currentRoom}`;
                        publishMessage(`${topicBase}/serial/data`, value);
                    }
                }
            } catch (error) {
                console.error(error);
            }
        }

        function unlockSerial() {
            if (!isSerialConnected) return;
            
            // Fecha portas
            if (serialWriter) serialWriter.close();
            if (serialReader) serialReader.cancel();
            if (serialPort) serialPort.close();
            
            isSerialConnected = false;
            serialPort = null;

            const topicBase = `multry/${currentRoom}`;
            publishMessage(`${topicBase}/serial/lock`, JSON.stringify({ action: 'unlock' }));
            publishMessage(`${topicBase}/presence`, JSON.stringify({
                type: 'update_serial',
                id: myId,
                hasSerial: false
            }));

            elBtnConnectSerial.textContent = "Conectar Serial";
            elBtnConnectSerial.disabled = false;
        }

        function updateSerialLock(data) {
            if (data.action === 'lock') {
                serialLockedBy = data.id;
                // Se não sou eu, desabilito botão
                if (data.id !== myId) {
                    elBtnConnectSerial.disabled = true;
                    elBtnConnectSerial.textContent = `Serial em uso por ${data.name}`;
                    addSystemMessage(`${data.name} conectou a serial.`);
                }
            } else if (data.action === 'unlock') {
                // Se quem liberou era quem travava
                if (serialLockedBy === data.id) {
                    serialLockedBy = null;
                    // Libera meu botão se eu não estou conectado
                    if (!isSerialConnected) {
                        elBtnConnectSerial.disabled = false;
                        elBtnConnectSerial.textContent = "Conectar Serial";
                    }
                }
            }
            // Atualiza lista visual de usuários para mostrar o indicador
            if (users[data.id]) {
                users[data.id].hasSerial = (data.action === 'lock');
                renderUsers();
            }
        }

        // --- Lógica do Terminal (Input/Output) ---
        
        // Adiciona texto ao terminal visual
        function appendToTerminal(text, localEcho) {
            // LocalEcho é opcional, se true é o que eu digitei
            elTerminalOutput.textContent += text;
            elTerminalOutput.scrollTop = elTerminalOutput.scrollHeight;
        }

        // Focar no input invisível quando clicar no terminal
        function focusTerminalInput() {
            elTerminalInputHidden.focus();
        }

        // Capturar teclado do campo invisível (funciona no mobile)
        elTerminalInputHidden.addEventListener('input', (e) => {
            const text = e.target.value;
            if (text) {
                // Envia para a serial via MQTT
                const topicBase = `multry/${currentRoom}`;
                publishMessage(`${topicBase}/serial/input`, text);
                
                // Limpa input para manter tamanho pequeno e permitir novo envio
                e.target.value = '';
            }
        });

        // Tratar o Backspace no campo invisível
        elTerminalInputHidden.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                // O evento input vai disparar, mas o valor pode estar vazio ou removido.
                // Em terminais reais, backspace envia o caractere 0x7F ou 0x08.
                const topicBase = `multry/${currentRoom}`;
                publishMessage(`${topicBase}/serial/input`, '\x08'); // Backspace
                e.target.value = ''; // Força limpeza
            }
        });

        // --- Botões Especiais ---
        
        function sendSpecialChar(char) {
            const topicBase = `multry/${currentRoom}`;
            publishMessage(`${topicBase}/serial/input`, char);
            focusTerminalInput();
        }

        function sendModifiedKey(modifier) {
            let inputId = '';
            let char = '';

            if (modifier === 'c') {
                inputId = 'ctrl-char';
            } else if (modifier === 'a') {
                inputId = 'alt-char';
            }

            const inputEl = document.getElementById(inputId);
            if (inputEl) {
                char = inputEl.value.toLowerCase();
                if (char.length === 1) {
                    let code = char.charCodeAt(0);
                    let payload = '';

                    if (modifier === 'c') {
                        // Ctrl + Letra (subtrai 64 do ASCII, ex: Ctrl+C = 3)
                        if (code >= 97 && code <= 122) { // a-z
                            payload = String.fromCharCode(code - 96);
                        }
                    } else if (modifier === 'a') {
                        // Alt + Letra (Envia Escape + caractere)
                        payload = '\x1b' + char;
                    }

                    if (payload) {
                        const topicBase = `multry/${currentRoom}`;
                        publishMessage(`${topicBase}/serial/input`, payload);
                        inputEl.value = ''; // Limpa campo
                        focusTerminalInput();
                    }
                }
            }
        }

        // --- Logs de Debug/Serial Data ---
        function logSerialData(data, direction) {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            // Escapa caracteres não imprimíveis para visualização
            let cleanData = data.replace(/[\x00-\x1F\x7F]/g, (m) => {
                const special = {'\t':'TAB','\n':'LF','\r':'CR'};
                return special[m] ? `{${special[m]}}` : `{\\x${m.charCodeAt(0).toString(16)}}`;
            });

            if (direction === 'tx') {
                div.className = 'log-tx';
                div.textContent = `[${timestamp}] >> ${cleanData}`;
            } else {
                div.className = 'log-rx';
                div.textContent = `[${timestamp}] << ${cleanData}`;
            }
            
            elSerialLog.appendChild(div);
            elSerialLog.scrollTop = elSerialLog.scrollHeight;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Notifica saída ao fechar a janela
        window.addEventListener('beforeunload', () => {
            if (isConnectedToMQTT) {
                const topicBase = `multry/${currentRoom}`;
                publishMessage(`${topicBase}/presence`, JSON.stringify({
                    type: 'leave',
                    id: myId
                }));
                unlockSerial();
            }
        });

    </script>
</body>
</html>